<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blood Supply Map — Global Blood System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --red: #C0292A;
  --red-light: #E63535;
  --red-dim: rgba(192,41,42,0.12);
  --bg: #0A0A0B;
  --surface: #111113;
  --surface2: #161618;
  --border: rgba(255,255,255,0.07);
  --text: #F0EDEA;
  --muted: #7A7672;
  --muted2: #9A9693;
  --green: #2ECC71;
  --yellow: #F39C12;
  --blue: #3B9BE8;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-weight: 300;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
  opacity: 0.4;
}

/* NAV */
nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 40px;
  border-bottom: 1px solid var(--border);
  background: rgba(10,10,11,0.95);
  backdrop-filter: blur(12px);
  z-index: 100;
  flex-shrink: 0;
}

.nav-logo {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  color: var(--text);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 10px;
}

.nav-logo-dot {
  width: 8px; height: 8px;
  background: var(--red);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.nav-links { display: flex; gap: 4px; }
.nav-links a {
  font-size: 11px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  text-decoration: none;
  padding: 5px 10px;
  border-radius: 2px;
  transition: color 0.2s, background 0.2s;
}
.nav-links a:hover { color: var(--text); background: var(--surface2); }
.nav-links a.active { color: var(--red-light); background: var(--surface2); }

/* MAIN LAYOUT */
.map-layout {
  display: flex;
  flex: 1;
  overflow: hidden;
  position: relative;
}

/* LEFT SIDEBAR */
.sidebar {
  width: 300px;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 10;
}

.sidebar-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
}

.sidebar-title {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 4px;
}

.sidebar-title em { color: var(--red); font-style: italic; }

.sidebar-sub {
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 0.06em;
}

.live-dot {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--green);
  margin-top: 8px;
}
.live-dot::before {
  content: '';
  width: 5px; height: 5px;
  background: var(--green);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

/* BLOOD TYPE FILTER */
.filter-section {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
}

.filter-label {
  font-size: 10px;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
}

.blood-filters {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

.bf-btn {
  padding: 7px 4px;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--muted2);
  font-family: 'Playfair Display', serif;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.2s;
  position: relative;
}
.bf-btn:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }
.bf-btn.active { background: var(--red-dim); border-color: rgba(192,41,42,0.5); color: var(--red-light); }
.bf-btn.all-btn { font-family: 'DM Sans', sans-serif; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; }

/* STATUS FILTER */
.status-filters {
  display: flex;
  gap: 6px;
  margin-top: 10px;
}
.sf-btn {
  flex: 1;
  padding: 6px 8px;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 10px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}
.sf-btn .dot { width: 5px; height: 5px; border-radius: 50%; }
.sf-btn.active-green { background: rgba(46,204,113,0.1); border-color: rgba(46,204,113,0.3); color: var(--green); }
.sf-btn.active-yellow { background: rgba(243,156,18,0.1); border-color: rgba(243,156,18,0.3); color: var(--yellow); }
.sf-btn.active-red { background: var(--red-dim); border-color: rgba(192,41,42,0.3); color: var(--red-light); }

/* CITY LIST */
.city-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}
.city-list::-webkit-scrollbar { width: 3px; }
.city-list::-webkit-scrollbar-track { background: transparent; }
.city-list::-webkit-scrollbar-thumb { background: var(--border); }

.city-item {
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
}
.city-item:hover { background: var(--surface2); }
.city-item.selected { background: rgba(192,41,42,0.06); border-left: 2px solid var(--red); }
.city-item.hidden-city { display: none; }

.city-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}
.city-name {
  font-size: 13.5px;
  font-weight: 500;
}
.city-status {
  width: 7px; height: 7px;
  border-radius: 50%;
}
.city-status.ok { background: var(--green); }
.city-status.low { background: var(--yellow); }
.city-status.critical { background: var(--red); box-shadow: 0 0 6px rgba(192,41,42,0.6); }

.city-country { font-size: 11px; color: var(--muted); margin-bottom: 8px; }

.mini-bars {
  display: flex;
  gap: 3px;
  align-items: flex-end;
  height: 20px;
}
.mini-bar {
  width: 12px;
  border-radius: 1px;
  transition: opacity 0.2s;
  position: relative;
}
.mini-bar.faded { opacity: 0.2; }

.city-units {
  font-size: 10px;
  color: var(--muted);
  margin-top: 5px;
  letter-spacing: 0.06em;
}

/* SIDEBAR FOOTER */
.sidebar-footer {
  padding: 12px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
}
.stat-pill {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 10px 8px;
  text-align: center;
  border-radius: 2px;
}
.stat-pill-val {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  display: block;
}
.stat-pill-key {
  font-size: 9px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  margin-top: 2px;
  display: block;
}

/* MAP AREA */
.map-area {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: #0D0E10;
}

.map-bg {
  width: 100%;
  height: 100%;
  position: absolute;
  inset: 0;
}

/* SVG Map */
#worldSvg {
  width: 100%;
  height: 100%;
  position: absolute;
  inset: 0;
  cursor: grab;
}
#worldSvg:active { cursor: grabbing; }

.country-path {
  fill: #1a1c20;
  stroke: #2a2d33;
  stroke-width: 0.4;
  transition: fill 0.2s;
}
.country-path:hover { fill: #22252a; }

/* MAP MARKERS */
.map-marker {
  cursor: pointer;
  transition: all 0.2s;
}
.marker-ring {
  fill: none;
  stroke-width: 1;
  opacity: 0.5;
  animation: markerPulse 2.5s infinite;
}
.marker-dot { transition: r 0.2s; }
.map-marker:hover .marker-dot { r: 7; }

@keyframes markerPulse {
  0%  { r: 10; opacity: 0.5; }
  100%{ r: 22; opacity: 0; }
}

/* TOOLTIP */
.map-tooltip {
  position: absolute;
  background: #0A0A0B;
  border: 1px solid rgba(255,255,255,0.12);
  padding: 16px 20px;
  min-width: 240px;
  pointer-events: none;
  z-index: 200;
  display: none;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
.map-tooltip.visible { display: block; }

.tt-city {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 2px;
}
.tt-country { font-size: 11px; color: var(--muted); margin-bottom: 12px; }

.tt-type-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  margin-bottom: 12px;
}
.tt-type {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 6px 4px;
  text-align: center;
  border-radius: 2px;
}
.tt-type-name {
  font-family: 'Playfair Display', serif;
  font-size: 13px;
  font-weight: 700;
  display: block;
}
.tt-type-units {
  font-size: 9px;
  color: var(--muted);
  letter-spacing: 0.06em;
  display: block;
  margin-top: 2px;
}
.tt-type-name.ok { color: var(--green); }
.tt-type-name.low { color: var(--yellow); }
.tt-type-name.critical { color: var(--red-light); }

.tt-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 10px;
  border-top: 1px solid var(--border);
}
.tt-total-label { font-size: 10px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
.tt-total-val { font-family: 'Playfair Display', serif; font-size: 18px; }

/* MAP CONTROLS */
.map-controls {
  position: absolute;
  bottom: 24px;
  right: 24px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  z-index: 50;
}
.mc-btn {
  width: 36px; height: 36px;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--muted2);
  font-size: 18px;
  cursor: pointer;
  border-radius: 2px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.mc-btn:hover { background: var(--surface2); color: var(--text); border-color: rgba(255,255,255,0.15); }
.mc-btn svg { width: 16px; height: 16px; }

/* LEGEND */
.map-legend {
  position: absolute;
  bottom: 24px;
  left: 24px;
  background: rgba(10,10,11,0.9);
  border: 1px solid var(--border);
  padding: 14px 16px;
  z-index: 50;
  backdrop-filter: blur(8px);
}
.legend-title {
  font-size: 9px;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
}
.legend-items { display: flex; flex-direction: column; gap: 7px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--muted2); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* SEARCH */
.map-search {
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 50;
}
.map-search input {
  background: rgba(10,10,11,0.9);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  padding: 9px 16px 9px 36px;
  outline: none;
  width: 260px;
  backdrop-filter: blur(8px);
  border-radius: 2px;
  transition: border-color 0.2s;
}
.map-search input:focus { border-color: rgba(192,41,42,0.4); }
.map-search input::placeholder { color: var(--muted); }
.map-search svg {
  position: absolute;
  left: 10px; top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
  width: 14px; height: 14px;
  pointer-events: none;
}

/* ANIMATIONS */
@keyframes pulse {
  0%,100% { opacity: 1; transform: scale(1); }
  50%      { opacity: 0.4; transform: scale(0.7); }
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* DETAIL PANEL (right) */
.detail-panel {
  position: absolute;
  top: 0; right: 0;
  width: 280px;
  height: 100%;
  background: var(--surface);
  border-left: 1px solid var(--border);
  z-index: 60;
  transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.detail-panel.open { transform: translateX(0); }

.dp-header {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.dp-close {
  position: absolute;
  top: 16px; right: 16px;
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  width: 28px; height: 28px;
  border-radius: 2px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.2s;
}
.dp-close:hover { color: var(--text); }
.dp-close svg { width: 12px; height: 12px; }
.dp-city { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; margin-bottom: 2px; }
.dp-city em { color: var(--red); font-style: italic; }
.dp-country { font-size: 11px; color: var(--muted); }

.dp-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
.dp-body::-webkit-scrollbar { width: 3px; }
.dp-body::-webkit-scrollbar-thumb { background: var(--border); }

.dp-section-title {
  font-size: 9px;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin: 16px 0 10px;
}
.dp-section-title:first-child { margin-top: 0; }

.dp-type-list { display: flex; flex-direction: column; gap: 0; }
.dp-type-row {
  display: flex;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  gap: 10px;
}
.dp-type-row:last-child { border-bottom: none; }
.dp-type-name {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 700;
  width: 36px;
  flex-shrink: 0;
}
.dp-type-name.ok { color: var(--green); }
.dp-type-name.low { color: var(--yellow); }
.dp-type-name.critical { color: var(--red-light); }
.dp-bar-wrap { flex: 1; height: 4px; background: var(--border); border-radius: 2px; }
.dp-bar { height: 100%; border-radius: 2px; }
.dp-units { font-size: 11px; color: var(--muted2); text-align: right; min-width: 52px; }

.dp-stat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 4px;
}
.dp-stat {
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 12px;
  border-radius: 2px;
}
.dp-stat-val { font-family: 'Playfair Display', serif; font-size: 18px; display: block; }
.dp-stat-key { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-top: 3px; display: block; }

.dp-alert {
  background: var(--red-dim);
  border: 1px solid rgba(192,41,42,0.25);
  padding: 10px 12px;
  font-size: 12px;
  color: var(--muted2);
  margin-top: 8px;
  display: flex;
  gap: 8px;
  align-items: flex-start;
}
.dp-alert svg { width: 14px; height: 14px; color: var(--red-light); flex-shrink: 0; margin-top: 1px; }

@media (max-width: 900px) {
  .sidebar { width: 240px; }
  nav { padding: 14px 20px; }
  .nav-links { display: none; }
}
@media (max-width: 640px) {
  .sidebar { display: none; }
  body { overflow: auto; }
}
</style>
</head>
<body>

<nav>
  <a href="index.html" class="nav-logo"><span class="nav-logo-dot"></span>GBS</a>
  <div class="nav-links">
    <a href="donors.html">Donors</a>
    <a href="storage.html">Storage</a>
    <a href="monitoring.html">Monitoring</a>
    <a href="hospitals.html">Hospitals</a>
    <a href="logistics.html">Logistics</a>
    <a href="network.html">Network</a>
    <a href="map.html" class="active">Map</a>
  </div>
</nav>

<div class="map-layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Blood <em>Supply</em> Map</div>
      <div class="sidebar-sub">Global inventory overview</div>
      <div class="live-dot">Live — updated 8s ago</div>
    </div>

    <div class="filter-section">
      <div class="filter-label">Filter by blood type</div>
      <div class="blood-filters">
        <button class="bf-btn all-btn active" data-type="ALL" onclick="filterType('ALL',this)">All</button>
        <button class="bf-btn" data-type="O+" onclick="filterType('O+',this)">O+</button>
        <button class="bf-btn" data-type="O−" onclick="filterType('O−',this)">O−</button>
        <button class="bf-btn" data-type="A+" onclick="filterType('A+',this)">A+</button>
        <button class="bf-btn" data-type="A−" onclick="filterType('A−',this)">A−</button>
        <button class="bf-btn" data-type="B+" onclick="filterType('B+',this)">B+</button>
        <button class="bf-btn" data-type="B−" onclick="filterType('B−',this)">B−</button>
        <button class="bf-btn" data-type="AB+" onclick="filterType('AB+',this)">AB+</button>
        <button class="bf-btn" data-type="AB−" onclick="filterType('AB−',this)">AB−</button>
      </div>

      <div class="status-filters">
        <button class="sf-btn" id="sf-ok" onclick="toggleStatus('ok',this)">
          <span class="dot" style="background:var(--green)"></span> Good
        </button>
        <button class="sf-btn" id="sf-low" onclick="toggleStatus('low',this)">
          <span class="dot" style="background:var(--yellow)"></span> Low
        </button>
        <button class="sf-btn" id="sf-critical" onclick="toggleStatus('critical',this)">
          <span class="dot" style="background:var(--red)"></span> Critical
        </button>
      </div>
    </div>

    <div class="city-list" id="cityList"></div>

    <div class="sidebar-footer">
      <div class="stat-pill"><span class="stat-pill-val" id="totalUnits">0</span><span class="stat-pill-key">Total Units</span></div>
      <div class="stat-pill"><span class="stat-pill-val" id="totalCities">0</span><span class="stat-pill-key">Cities</span></div>
      <div class="stat-pill"><span class="stat-pill-val" id="criticalCount" style="color:var(--red-light)">0</span><span class="stat-pill-key">Critical</span></div>
    </div>
  </div>

  <!-- MAP AREA -->
  <div class="map-area" id="mapArea">

    <!-- Search -->
    <div class="map-search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" placeholder="Search city…" oninput="searchCity(this.value)" id="searchInput">
    </div>

    <!-- SVG World Map -->
    <svg id="worldSvg" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="bgGrad" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#141618"/>
          <stop offset="100%" stop-color="#0D0E10"/>
        </radialGradient>
      </defs>
      <rect width="1000" height="500" fill="url(#bgGrad)"/>

      <!-- Simplified continent shapes -->
      <g id="continents">
        <!-- North America -->
        <path class="country-path" d="M 60 60 L 160 50 L 230 80 L 250 120 L 260 160 L 240 200 L 220 230 L 190 250 L 160 260 L 130 240 L 100 220 L 80 190 L 60 160 L 50 130 Z"/>
        <!-- Mexico / Central America -->
        <path class="country-path" d="M 160 260 L 190 250 L 210 270 L 200 300 L 185 310 L 170 300 L 155 280 Z"/>
        <!-- Greenland -->
        <path class="country-path" d="M 200 20 L 240 15 L 260 30 L 250 55 L 220 60 L 195 45 Z"/>
        <!-- South America -->
        <path class="country-path" d="M 175 310 L 200 300 L 240 310 L 260 350 L 265 390 L 250 430 L 225 460 L 200 460 L 180 440 L 165 400 L 155 360 L 155 330 Z"/>
        <!-- Europe -->
        <path class="country-path" d="M 420 55 L 490 50 L 530 65 L 540 90 L 520 110 L 490 120 L 460 115 L 430 105 L 415 85 Z"/>
        <!-- Scandinavia -->
        <path class="country-path" d="M 450 30 L 490 25 L 510 45 L 500 65 L 470 60 L 450 45 Z"/>
        <!-- UK/Ireland -->
        <path class="country-path" d="M 400 60 L 420 55 L 425 75 L 410 80 L 398 70 Z"/>
        <!-- Russia -->
        <path class="country-path" d="M 520 30 L 700 25 L 780 50 L 800 80 L 770 100 L 700 110 L 620 115 L 560 100 L 530 80 L 515 55 Z"/>
        <!-- Middle East -->
        <path class="country-path" d="M 530 115 L 580 110 L 610 125 L 615 150 L 590 165 L 560 160 L 535 145 Z"/>
        <!-- Africa -->
        <path class="country-path" d="M 450 140 L 520 135 L 550 160 L 560 210 L 555 270 L 530 320 L 500 360 L 480 380 L 460 370 L 440 330 L 430 280 L 430 230 L 440 180 Z"/>
        <!-- South Africa -->
        <path class="country-path" d="M 460 370 L 500 360 L 515 380 L 505 400 L 480 405 L 460 390 Z"/>
        <!-- Central Asia -->
        <path class="country-path" d="M 580 90 L 680 85 L 710 110 L 700 135 L 660 145 L 610 140 L 585 120 Z"/>
        <!-- India -->
        <path class="country-path" d="M 635 140 L 680 135 L 700 160 L 695 200 L 670 230 L 645 220 L 630 190 L 625 160 Z"/>
        <!-- SE Asia / Indonesia -->
        <path class="country-path" d="M 730 170 L 790 160 L 820 180 L 815 210 L 780 220 L 740 210 L 725 195 Z"/>
        <!-- China / East Asia -->
        <path class="country-path" d="M 700 80 L 800 70 L 840 90 L 850 130 L 820 160 L 760 165 L 700 150 L 680 125 L 690 100 Z"/>
        <!-- Japan -->
        <path class="country-path" d="M 850 90 L 875 85 L 885 105 L 870 120 L 850 115 Z"/>
        <!-- Australia -->
        <path class="country-path" d="M 760 310 L 850 295 L 890 320 L 900 370 L 875 410 L 820 425 L 770 415 L 745 385 L 740 345 Z"/>
        <!-- New Zealand -->
        <path class="country-path" d="M 910 380 L 930 370 L 935 395 L 920 405 L 908 395 Z"/>
      </g>

      <!-- Graticule lines -->
      <g stroke="rgba(255,255,255,0.04)" stroke-width="0.5" fill="none">
        <line x1="0" y1="125" x2="1000" y2="125"/>
        <line x1="0" y1="250" x2="1000" y2="250"/>
        <line x1="0" y1="375" x2="1000" y2="375"/>
        <line x1="250" y1="0" x2="250" y2="500"/>
        <line x1="500" y1="0" x2="500" y2="500"/>
        <line x1="750" y1="0" x2="750" y2="500"/>
      </g>

      <!-- MARKERS GROUP -->
      <g id="markersGroup"></g>
    </svg>

    <!-- TOOLTIP -->
    <div class="map-tooltip" id="mapTooltip"></div>

    <!-- LEGEND -->
    <div class="map-legend">
      <div class="legend-title">Supply Status</div>
      <div class="legend-items">
        <div class="legend-item"><span class="legend-dot" style="background:var(--green)"></span> Good (&gt; 200 units)</div>
        <div class="legend-item"><span class="legend-dot" style="background:var(--yellow)"></span> Low (50–200 units)</div>
        <div class="legend-item"><span class="legend-dot" style="background:var(--red); box-shadow:0 0 6px rgba(192,41,42,0.6)"></span> Critical (&lt; 50 units)</div>
      </div>
    </div>

    <!-- MAP CONTROLS -->
    <div class="map-controls">
      <button class="mc-btn" onclick="zoomIn()" title="Zoom In">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="mc-btn" onclick="zoomOut()" title="Zoom Out">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="mc-btn" onclick="resetView()" title="Reset View">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      </button>
    </div>
  </div>

  <!-- DETAIL PANEL -->
  <div class="detail-panel" id="detailPanel">
    <div class="dp-header">
      <button class="dp-close" onclick="closeDetail()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <div class="dp-city" id="dpCity">—</div>
      <div class="dp-country" id="dpCountry">—</div>
    </div>
    <div class="dp-body" id="dpBody"></div>
  </div>

</div>

<script>
// ═══════════════════════════════════
// DATA
// ═══════════════════════════════════
const BLOOD_TYPES = ['O+','O−','A+','A−','B+','B−','AB+','AB−'];

const cities = [
  { id:'nyc',   name:'New York',      country:'United States', cx:190, cy:145, units:{ 'O+':1240,'O−':88,'A+':980,'A−':34,'B+':610,'B−':120,'AB+':195,'AB−':12 } },
  { id:'lon',   name:'London',        country:'United Kingdom', cx:415, cy:70, units:{ 'O+':890,'O−':120,'A+':720,'A−':45,'B+':380,'B−':90,'AB+':140,'AB−':18 } },
  { id:'par',   name:'Paris',         country:'France',         cx:445, cy:80, units:{ 'O+':760,'O−':55,'A+':640,'A−':28,'B+':310,'B−':62,'AB+':110,'AB−':9 } },
  { id:'ber',   name:'Berlin',        country:'Germany',        cx:470, cy:68, units:{ 'O+':820,'O−':95,'A+':700,'A−':38,'B+':340,'B−':75,'AB+':125,'AB−':14 } },
  { id:'mos',   name:'Moscow',        country:'Russia',         cx:555, cy:60, units:{ 'O+':1100,'O−':40,'A+':900,'A−':22,'B+':560,'B−':48,'AB+':180,'AB−':8 } },
  { id:'dxb',   name:'Dubai',         country:'UAE',            cx:600, cy:140, units:{ 'O+':440,'O−':18,'A+':360,'A−':8,'B+':190,'B−':20,'AB+':70,'AB−':3 } },
  { id:'mum',   name:'Mumbai',        country:'India',          cx:645, cy:175, units:{ 'O+':980,'O−':22,'A+':680,'A−':14,'B+':520,'B−':28,'AB+':160,'AB−':6 } },
  { id:'bej',   name:'Beijing',       country:'China',          cx:780, cy:110, units:{ 'O+':1380,'O−':62,'A+':1100,'A−':31,'B+':740,'B−':68,'AB+':220,'AB−':15 } },
  { id:'tky',   name:'Tokyo',         country:'Japan',          cx:855, cy:108, units:{ 'O+':1050,'O−':50,'A+':860,'A−':25,'B+':490,'B−':55,'AB+':175,'AB−':11 } },
  { id:'syd',   name:'Sydney',        country:'Australia',      cx:845, cy:375, units:{ 'O+':620,'O−':70,'A+':500,'A−':32,'B+':260,'B−':58,'AB+':95,'AB−':10 } },
  { id:'sao',   name:'São Paulo',     country:'Brazil',         cx:215, cy:385, units:{ 'O+':1100,'O−':15,'A+':820,'A−':10,'B+':410,'B−':14,'AB+':130,'AB−':4 } },
  { id:'lag',   name:'Lagos',         country:'Nigeria',        cx:455, cy:240, units:{ 'O+':380,'O−':8,'A+':270,'A−':4,'B+':180,'B−':6,'AB+':55,'AB−':2 } },
  { id:'cai',   name:'Cairo',         country:'Egypt',          cx:535, cy:150, units:{ 'O+':560,'O−':12,'A+':420,'A−':7,'B+':240,'B−':11,'AB+':85,'AB−':3 } },
  { id:'joh',   name:'Johannesburg',  country:'South Africa',   cx:498, cy:365, units:{ 'O+':430,'O−':28,'A+':320,'A−':16,'B+':170,'B−':22,'AB+':60,'AB−':5 } },
  { id:'tor',   name:'Toronto',       country:'Canada',         cx:175, cy:125, units:{ 'O+':700,'O−':80,'A+':580,'A−':35,'B+':290,'B−':65,'AB+':110,'AB−':12 } },
  { id:'sgp',   name:'Singapore',     country:'Singapore',      cx:758, cy:210, units:{ 'O+':510,'O−':20,'A+':390,'A−':12,'B+':210,'B−':18,'AB+':75,'AB−':4 } },
  { id:'bkk',   name:'Bangkok',       country:'Thailand',       cx:740, cy:195, units:{ 'O+':620,'O−':14,'A+':470,'A−':9,'B+':250,'B−':15,'AB+':90,'AB−':3 } },
  { id:'mex',   name:'Mexico City',   country:'Mexico',         cx:155, cy:210, units:{ 'O+':830,'O−':19,'A+':590,'A−':11,'B+':310,'B−':16,'AB+':100,'AB−':4 } },
  { id:'mad',   name:'Madrid',        country:'Spain',          cx:418, cy:88, units:{ 'O+':580,'O−':42,'A+':460,'A−':22,'B+':220,'B−':40,'AB+':80,'AB−':7 } },
  { id:'ist',   name:'Istanbul',      country:'Turkey',         cx:530, cy:95, units:{ 'O+':740,'O−':30,'A+':580,'A−':18,'B+':310,'B−':28,'AB+':115,'AB−':6 } },
  { id:'bue',   name:'Buenos Aires',  country:'Argentina',      cx:210, cy:435, units:{ 'O+':490,'O−':22,'A+':370,'A−':12,'B+':180,'B−':18,'AB+':65,'AB−':4 } },
  { id:'nai',   name:'Nairobi',       country:'Kenya',          cx:538, cy:285, units:{ 'O+':210,'O−':5,'A+':155,'A−':3,'B+':95,'B−':4,'AB+':28,'AB−':1 } },
  { id:'khi',   name:'Karachi',       country:'Pakistan',       cx:620, cy:155, units:{ 'O+':660,'O−':16,'A+':480,'A−':9,'B+':290,'B−':13,'AB+':95,'AB−':3 } },
  { id:'ams',   name:'Amsterdam',     country:'Netherlands',    cx:448, cy:62, units:{ 'O+':480,'O−':58,'A+':390,'A−':28,'B+':195,'B−':50,'AB+':72,'AB−':9 } },
];

// ═══════════════════════════════════
// STATE
// ═══════════════════════════════════
let activeType = 'ALL';
let activeStatuses = new Set();
let selectedCity = null;
let viewBox = { x:0, y:0, w:1000, h:500 };
let isDragging = false;
let dragStart = { x:0, y:0 };

// ═══════════════════════════════════
// HELPERS
// ═══════════════════════════════════
function getTotal(city) {
  return Object.values(city.units).reduce((a,b)=>a+b,0);
}

function getTypeUnits(city, type) {
  if (type === 'ALL') return getTotal(city);
  return city.units[type] || 0;
}

function getStatus(city, type) {
  const u = getTypeUnits(city, type);
  if (u < 50) return 'critical';
  if (u < 200) return 'low';
  return 'ok';
}

function statusColor(s) {
  if (s === 'ok') return 'var(--green)';
  if (s === 'low') return 'var(--yellow)';
  return 'var(--red)';
}

function typeClass(units) {
  if (units < 50)  return 'critical';
  if (units < 200) return 'low';
  return 'ok';
}

function maxUnits(city) {
  return Math.max(...Object.values(city.units));
}

// ═══════════════════════════════════
// RENDER SIDEBAR
// ═══════════════════════════════════
function renderSidebar() {
  const list = document.getElementById('cityList');
  let total = 0, critCount = 0;

  list.innerHTML = cities.map(city => {
    const status = getStatus(city, activeType);
    const isHidden = activeStatuses.size > 0 && !activeStatuses.has(status);
    const units = getTypeUnits(city, activeType);
    total += units;
    if (status === 'critical') critCount++;

    const bars = BLOOD_TYPES.map(t => {
      const u = city.units[t];
      const h = Math.max(4, Math.round((u / maxUnits(city)) * 20));
      const faded = activeType !== 'ALL' && activeType !== t;
      const c = typeClass(u);
      const col = c === 'ok' ? '#2ECC71' : c === 'low' ? '#F39C12' : '#E63535';
      return `<div class="mini-bar ${faded?'faded':''}" style="height:${h}px;background:${col}"></div>`;
    }).join('');

    return `
      <div class="city-item ${selectedCity?.id===city.id?'selected':''} ${isHidden?'hidden-city':''}" 
           id="ci-${city.id}" onclick="selectCity('${city.id}')">
        <div class="city-top">
          <span class="city-name">${city.name}</span>
          <span class="city-status ${status}"></span>
        </div>
        <div class="city-country">${city.country}</div>
        <div class="mini-bars">${bars}</div>
        <div class="city-units">${units.toLocaleString()} unit${units!==1?'s':''} ${activeType!=='ALL'?'('+activeType+')':''}</div>
      </div>`;
  }).join('');

  document.getElementById('totalUnits').textContent = total.toLocaleString();
  document.getElementById('totalCities').textContent = cities.length;
  document.getElementById('criticalCount').textContent = critCount;
}

// ═══════════════════════════════════
// RENDER MARKERS
// ═══════════════════════════════════
function renderMarkers() {
  const g = document.getElementById('markersGroup');
  g.innerHTML = '';

  cities.forEach(city => {
    const status = getStatus(city, activeType);
    const isHidden = activeStatuses.size > 0 && !activeStatuses.has(status);
    if (isHidden) return;

    const col = statusColor(status);
    const isSelected = selectedCity?.id === city.id;

    const marker = document.createElementNS('http://www.w3.org/2000/svg','g');
    marker.classList.add('map-marker');
    marker.setAttribute('transform', `translate(${city.cx},${city.cy})`);
    marker.dataset.id = city.id;

    marker.innerHTML = `
      <circle class="marker-ring" r="12" stroke="${col}"/>
      <circle class="marker-dot" r="${isSelected?8:5}" fill="${col}" opacity="0.9"/>
      ${isSelected ? `<circle r="10" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.6"/>` : ''}
    `;

    marker.addEventListener('mouseenter', (e) => showTooltip(city, e));
    marker.addEventListener('mouseleave', hideTooltip);
    marker.addEventListener('click', () => selectCity(city.id));

    g.appendChild(marker);
  });
}

// ═══════════════════════════════════
// TOOLTIP
// ═══════════════════════════════════
function showTooltip(city, e) {
  const tt = document.getElementById('mapTooltip');
  const types = BLOOD_TYPES.map(t => {
    const u = city.units[t];
    const cls = typeClass(u);
    const show = activeType === 'ALL' || activeType === t;
    return `<div class="tt-type" style="${!show?'opacity:0.3':''}">
      <span class="tt-type-name ${cls}">${t}</span>
      <span class="tt-type-units">${u}</span>
    </div>`;
  }).join('');

  const total = getTotal(city);
  tt.innerHTML = `
    <div class="tt-city">${city.name}</div>
    <div class="tt-country">${city.country}</div>
    <div class="tt-type-grid">${types}</div>
    <div class="tt-total">
      <span class="tt-total-label">Total Units</span>
      <span class="tt-total-val">${total.toLocaleString()}</span>
    </div>
  `;

  const mapArea = document.getElementById('mapArea');
  const rect = mapArea.getBoundingClientRect();
  let left = e.clientX - rect.left + 16;
  let top  = e.clientY - rect.top  - 20;

  // Prevent overflow right
  if (left + 260 > rect.width) left = e.clientX - rect.left - 270;
  if (top + 200 > rect.height)  top  = e.clientY - rect.top  - 200;

  tt.style.left = left + 'px';
  tt.style.top  = top  + 'px';
  tt.classList.add('visible');
}

function hideTooltip() {
  document.getElementById('mapTooltip').classList.remove('visible');
}

// ═══════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════
function selectCity(id) {
  selectedCity = cities.find(c => c.id === id);
  if (!selectedCity) return;

  // Highlight sidebar item
  document.querySelectorAll('.city-item').forEach(el => el.classList.remove('selected'));
  const el = document.getElementById('ci-' + id);
  if (el) { el.classList.add('selected'); el.scrollIntoView({ behavior:'smooth', block:'nearest' }); }

  openDetail(selectedCity);
  renderMarkers();
}

function openDetail(city) {
  document.getElementById('dpCity').innerHTML = city.name.split(' ').map((w,i) => i===0 ? w : `<em>${w}</em>`).join(' ');
  document.getElementById('dpCountry').textContent = city.country;

  const max = maxUnits(city);
  const total = getTotal(city);
  const criticals = BLOOD_TYPES.filter(t => city.units[t] < 50);

  const rows = BLOOD_TYPES.map(t => {
    const u = city.units[t];
    const cls = typeClass(u);
    const col = cls==='ok'?'var(--green)':cls==='low'?'var(--yellow)':'var(--red-light)';
    const pct = Math.round((u/max)*100);
    const isActive = activeType === 'ALL' || activeType === t;
    return `
      <div class="dp-type-row" style="${!isActive?'opacity:0.35':''}">
        <span class="dp-type-name ${cls}">${t}</span>
        <div class="dp-bar-wrap"><div class="dp-bar" style="width:${pct}%;background:${col}"></div></div>
        <span class="dp-units">${u.toLocaleString()}</span>
      </div>`;
  }).join('');

  const alertHtml = criticals.length > 0
    ? `<div class="dp-alert">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Critical shortage: ${criticals.join(', ')} — redistribution recommended
      </div>` : '';

  document.getElementById('dpBody').innerHTML = `
    <div class="dp-section-title">Blood Type Inventory</div>
    <div class="dp-type-list">${rows}</div>

    <div class="dp-section-title" style="margin-top:20px">Station Overview</div>
    <div class="dp-stat-grid">
      <div class="dp-stat"><span class="dp-stat-val">${total.toLocaleString()}</span><span class="dp-stat-key">Total Units</span></div>
      <div class="dp-stat"><span class="dp-stat-val">${criticals.length}</span><span class="dp-stat-key">Critical Types</span></div>
      <div class="dp-stat"><span class="dp-stat-val">42d</span><span class="dp-stat-key">Max Shelf Life</span></div>
      <div class="dp-stat"><span class="dp-stat-val">24/7</span><span class="dp-stat-key">Monitoring</span></div>
    </div>
    ${alertHtml}
  `;

  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
  selectedCity = null;
  renderMarkers();
  document.querySelectorAll('.city-item').forEach(el => el.classList.remove('selected'));
}

// ═══════════════════════════════════
// FILTERS
// ═══════════════════════════════════
function filterType(type, btn) {
  activeType = type;
  document.querySelectorAll('.bf-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderSidebar();
  renderMarkers();
  if (selectedCity) openDetail(selectedCity);
}

function toggleStatus(status, btn) {
  if (activeStatuses.has(status)) {
    activeStatuses.delete(status);
    btn.className = 'sf-btn';
  } else {
    activeStatuses.add(status);
    btn.className = 'sf-btn active-' + (status==='ok'?'green':status==='low'?'yellow':'red');
  }
  renderSidebar();
  renderMarkers();
}

function searchCity(val) {
  const v = val.toLowerCase();
  document.querySelectorAll('.city-item').forEach(el => {
    const name = el.querySelector('.city-name').textContent.toLowerCase();
    const country = el.querySelector('.city-country').textContent.toLowerCase();
    el.style.display = (!v || name.includes(v) || country.includes(v)) ? '' : 'none';
  });
}

// ═══════════════════════════════════
// MAP PAN + ZOOM
// ═══════════════════════════════════
const svg = document.getElementById('worldSvg');

function applyView() {
  svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
}

function zoomIn() {
  const cx = viewBox.x + viewBox.w/2;
  const cy = viewBox.y + viewBox.h/2;
  viewBox.w *= 0.75; viewBox.h *= 0.75;
  viewBox.x = cx - viewBox.w/2;
  viewBox.y = cy - viewBox.h/2;
  clampView(); applyView();
}

function zoomOut() {
  const cx = viewBox.x + viewBox.w/2;
  const cy = viewBox.y + viewBox.h/2;
  viewBox.w = Math.min(viewBox.w * 1.33, 1400);
  viewBox.h = Math.min(viewBox.h * 1.33, 700);
  viewBox.x = cx - viewBox.w/2;
  viewBox.y = cy - viewBox.h/2;
  clampView(); applyView();
}

function resetView() {
  viewBox = { x:0, y:0, w:1000, h:500 };
  applyView();
}

function clampView() {
  viewBox.x = Math.max(-100, Math.min(viewBox.x, 1000 - viewBox.w + 100));
  viewBox.y = Math.max(-50,  Math.min(viewBox.y, 500  - viewBox.h + 50));
}

svg.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 1.12 : 0.88;
  const rect = svg.getBoundingClientRect();
  const mx = ((e.clientX - rect.left) / rect.width)  * viewBox.w + viewBox.x;
  const my = ((e.clientY - rect.top)  / rect.height) * viewBox.h + viewBox.y;
  viewBox.w *= factor; viewBox.h *= factor;
  viewBox.x = mx - ((e.clientX - rect.left) / rect.width)  * viewBox.w;
  viewBox.y = my - ((e.clientY - rect.top)  / rect.height) * viewBox.h;
  viewBox.w = Math.min(viewBox.w, 1400); viewBox.h = Math.min(viewBox.h, 700);
  clampView(); applyView();
}, { passive: false });

svg.addEventListener('mousedown', e => {
  isDragging = true;
  dragStart = { x: e.clientX, y: e.clientY };
});
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  const rect = svg.getBoundingClientRect();
  const dx = (e.clientX - dragStart.x) / rect.width  * viewBox.w;
  const dy = (e.clientY - dragStart.y) / rect.height * viewBox.h;
  viewBox.x -= dx; viewBox.y -= dy;
  dragStart = { x: e.clientX, y: e.clientY };
  clampView(); applyView();
});
window.addEventListener('mouseup', () => { isDragging = false; });

// ═══════════════════════════════════
// INIT
// ═══════════════════════════════════
renderSidebar();
renderMarkers();

// Simulate live updates
setInterval(() => {
  cities.forEach(city => {
    BLOOD_TYPES.forEach(t => {
      const delta = Math.floor(Math.random() * 5) - 2;
      city.units[t] = Math.max(0, city.units[t] + delta);
    });
  });
  renderSidebar();
  renderMarkers();
  if (selectedCity) openDetail(selectedCity);
}, 8000);
</script>

</body>
</html>
